---
phase: 02-creative-library-story-setup
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/stores/library-store.ts
  - src/hooks/use-library-items.ts
  - src/components/library/CharacterList.tsx
  - src/components/library/CharacterList.css
  - src/components/library/SettingList.tsx
  - src/components/library/SettingList.css
  - src/components/library/LibraryItemCard.tsx
  - src/components/library/LibraryItemCard.css
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new character profile from a template and edit it in the textarea"
    - "User can create a new setting/location entry from a template and edit it in the textarea"
    - "User can see a list of characters in the Characters tab"
    - "User can see a list of settings in the Settings tab"
    - "Clicking a library item loads its markdown into the textarea"
    - "Library items persist across page refresh"
  artifacts:
    - path: "src/stores/library-store.ts"
      provides: "Zustand store for current library editing state"
      contains: "useLibraryStore"
    - path: "src/hooks/use-library-items.ts"
      provides: "CRUD operations for library items via SQLite"
      exports: ["useLibraryItems", "useCreateLibraryItem", "useUpdateLibraryItem", "useDeleteLibraryItem"]
    - path: "src/components/library/CharacterList.tsx"
      provides: "Characters tab content with list and create button"
    - path: "src/components/library/SettingList.tsx"
      provides: "Settings tab content with list and create button"
  key_links:
    - from: "src/components/library/CharacterList.tsx"
      to: "src/hooks/use-library-items.ts"
      via: "hook usage"
      pattern: "useLibraryItems.*character"
    - from: "src/hooks/use-library-items.ts"
      to: "src/services/db.ts"
      via: "getDatabase() queries"
      pattern: "getDatabase"
    - from: "src/App.tsx"
      to: "src/components/library/CharacterList.tsx"
      via: "tab definition"
      pattern: "Characters"
---

<objective>
Build the character and setting library: Zustand store, CRUD hooks, and tab UI for creating, listing, and editing library items. Users click "New Character" or "New Setting" to create from template, items appear in left pane lists, clicking loads markdown into the textarea for editing.

Purpose: Satisfies LIB-01 (character profiles) and LIB-02 (setting/location entries) — the core creative asset management that everything else builds on.
Output: Working Characters and Settings tabs with full CRUD, template-based creation, and textarea integration.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creative-library-story-setup/02-CONTEXT.md
@.planning/phases/02-creative-library-story-setup/02-01-SUMMARY.md
@src/types/index.ts
@src/services/db.ts
@src/services/markdown.ts
@src/stores/ui-store.ts
@src/components/tabs/TabSystem.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Library store and CRUD hooks</name>
  <files>src/stores/library-store.ts, src/hooks/use-library-items.ts</files>
  <action>
Create `src/stores/library-store.ts` — Zustand store for tracking the currently active library item being edited:

```typescript
interface LibraryState {
  activeItemId: string | null;
  activeItemType: LibraryItemType | null;
  setActiveItem: (id: string | null, type: LibraryItemType | null) => void;
}
```

Use plain Zustand (no persist — this is ephemeral UI state like ui-store).

Create `src/hooks/use-library-items.ts` — TanStack Query hooks for library item CRUD:

1. `useLibraryItems(type: LibraryItemType)` — query hook that fetches all library items of a given type from SQLite. Polls every 5s. Returns `{ items, isLoading, error }`.

2. `useLibraryItem(id: string | null)` — query hook for a single item by ID. Returns `{ item, isLoading }`. Disabled when id is null.

3. `useCreateLibraryItem()` — mutation that:
   - Fetches the default template for the given type from the templates table
   - Creates a new library_items row with UUID id (`crypto.randomUUID()`), the template content, version=1
   - Extracts the name from frontmatter using `extractName()` from markdown service
   - Returns the created item
   - Invalidates the library items query

4. `useUpdateLibraryItem()` — mutation that:
   - Updates the content and updated_at fields
   - Re-extracts name from frontmatter and updates the name column
   - Increments version
   - Invalidates queries
   - Parses tags from frontmatter and updates the tags column (JSON stringified array)

5. `useDeleteLibraryItem()` — mutation that deletes by ID, invalidates queries.

All database operations use `getDatabase()` from db service. Use `db.exec()` with callback for SELECT queries and parameterized SQL for INSERT/UPDATE/DELETE.

Key: when creating items, also parse the category from frontmatter and store it in the category column. Tags are stored as JSON string in the tags column.
  </action>
  <verify>
`npm run build` passes. Hooks are importable. Types align with database schema.
  </verify>
  <done>Library store tracks active item. CRUD hooks create/read/update/delete library items with frontmatter-based name/category/tag extraction. All operations persist to SQLite.</done>
</task>

<task type="auto">
  <name>Task 2: Characters and Settings tab UI with list components</name>
  <files>src/components/library/CharacterList.tsx, src/components/library/CharacterList.css, src/components/library/SettingList.tsx, src/components/library/SettingList.css, src/components/library/LibraryItemCard.tsx, src/components/library/LibraryItemCard.css, src/App.tsx</files>
  <action>
Create `src/components/library/LibraryItemCard.tsx` — reusable card component for displaying a library item in the left pane list:
- Shows name (from item.name), category badge, and tag chips
- Click handler calls `setActiveItem(id, type)` on the library store AND loads the item content into the textarea
- Active state styling when this item is currently selected
- Delete button (small, right-aligned) with confirmation
- Style: dark theme matching existing tab/settings styles. Compact cards with subtle borders.

Create `src/components/library/CharacterList.tsx`:
- Uses `useLibraryItems('character')` to fetch character list
- "New Character" button at top that calls `useCreateLibraryItem()` with type='character'
- After creation, auto-selects the new item and loads it into textarea
- Shows loading state while fetching
- Empty state message when no characters exist
- Simple search/filter by name (local filter on items array, no debounce needed — small lists)

Create `src/components/library/SettingList.tsx`:
- Same structure as CharacterList but for type='setting'
- "New Setting" button
- Identical patterns, just different type parameter

Create CSS files with dark theme styles matching existing components (use the same color palette: #1a1a2e bg, #16161e darker bg, #2a2a3e borders, #5c7cfa accent, #e8e8e8 text).

Modify `src/App.tsx`:
- Add Characters and Settings tabs to the tabs array
- Characters tab content: `<CharacterList />`
- Settings tab content: `<SettingList />`
- When a library item is active (from library-store), the right pane should show `<EnhancedTextarea>` with the item's contentId set to `library-{item.id}`
- Wire up the textarea so content changes save back to the library item (connect useAutoSave or add a save handler that calls useUpdateLibraryItem)

Important: The textarea component from Phase 1 uses `contentId` for version tracking. For library items, use `library-{item.id}` as the contentId. When switching between items, the textarea should update to show the new item's content.

Follow existing App.tsx patterns — the RightPaneContent component already conditionally renders based on activeTab. Add conditions for 'characters' and 'settings' tabs that render EnhancedTextarea with the active library item's content.
  </action>
  <verify>
`npm run build` passes. Navigate to Characters tab — "New Character" creates a character with template content. Click character → loads into textarea. Edit and save persists. Same for Settings tab.
  </verify>
  <done>Characters and Settings tabs visible in left pane. Users can create, view, edit, and delete character profiles and setting entries. Content loads into textarea on click. Changes persist to SQLite.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Characters tab shows "New Character" button and lists existing characters
- Settings tab shows "New Setting" button and lists existing settings
- Creating a character populates template content with YAML frontmatter
- Clicking a character loads its markdown into the right pane textarea
- Editing in textarea and waiting 2s auto-saves changes
- Changes persist across page refresh
- Delete removes items from list
</verification>

<success_criteria>
Complete character and setting library with CRUD operations, tab-based navigation, and textarea integration. Users can create creative assets from templates and edit them as markdown documents. LIB-01 and LIB-02 requirements satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/02-creative-library-story-setup/02-02-SUMMARY.md`
</output>
