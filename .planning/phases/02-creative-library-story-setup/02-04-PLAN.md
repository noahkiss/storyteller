---
phase: 02-creative-library-story-setup
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/components/library/OutlineEditor.tsx
  - src/components/library/OutlineEditor.css
  - src/hooks/use-outlines.ts
  - src/services/references.ts
autonomous: true

must_haves:
  truths:
    - "User can create and edit a chapter/scene outline for a story"
    - "Outline is a markdown document edited in the textarea"
    - "Library item names mentioned in the outline are automatically detected"
    - "Detected references show which characters and settings appear in each section"
  artifacts:
    - path: "src/hooks/use-outlines.ts"
      provides: "CRUD for story outlines"
      exports: ["useOutline", "useCreateOutline", "useUpdateOutline"]
    - path: "src/services/references.ts"
      provides: "Auto-detection of library item mentions in text"
      exports: ["detectLibraryReferences"]
    - path: "src/components/library/OutlineEditor.tsx"
      provides: "Outline editing UI with reference detection display"
  key_links:
    - from: "src/services/references.ts"
      to: "src/hooks/use-library-items.ts"
      via: "library item names for matching"
      pattern: "LibraryItem"
    - from: "src/hooks/use-outlines.ts"
      to: "src/services/db.ts"
      via: "SQLite queries"
      pattern: "getDatabase"
---

<objective>
Build the outline editor with automatic library reference detection. Users create story outlines as markdown documents (scenes as core unit, optional chapter grouping) and the system auto-detects mentions of library characters and settings.

Purpose: Satisfies SETUP-02 (chapter/scene outline with beat structure). The reference detection connects outlines to the creative library, enabling context injection in Phase 3.
Output: Working outline editor per story, auto-detection of library item mentions, reference display.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creative-library-story-setup/02-CONTEXT.md
@.planning/phases/02-creative-library-story-setup/02-RESEARCH.md
@.planning/phases/02-creative-library-story-setup/02-01-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-02-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-03-SUMMARY.md
@src/types/index.ts
@src/services/markdown.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Outline CRUD hooks and reference detection service</name>
  <files>src/hooks/use-outlines.ts, src/services/references.ts</files>
  <action>
Create `src/services/references.ts` — auto-detect library item mentions in text:

```typescript
import type { LibraryItem, LibraryReference } from '@/types';
import { escapeRegex } from './markdown';
```

Implement `detectLibraryReferences(text: string, libraryItems: LibraryItem[]): LibraryReference[]`:
- Filter items with names >= 3 characters (avoid false positives from short names per research pitfall #4)
- For each library item, create word-boundary regex: `\b{escapedName}\b` with 'gi' flag
- Count occurrences in the text
- Return array of { type, id, name, occurrences } for items with >= 1 occurrence
- Sort by occurrences descending

Keep it simple — no AST parsing needed here since outlines are plain markdown text. The regex approach with word boundaries is sufficient per research recommendation. The unified/remark AST traversal is more useful for marker processing (Plan 02-07).

Create `src/hooks/use-outlines.ts` — TanStack Query hooks:

1. `useOutline(storyId: string | null)` — query the outline for a story (outlines table has unique story_id). Returns `{ outline, isLoading }`. Disabled when storyId is null.

2. `useCreateOutline()` — mutation that creates outline with UUID id, story_id, and default content:

Default outline template:
```markdown
# Story Outline

## Chapter 1

### Scene 1
**Summary:**
**Characters:**
**Setting:**
**Mood:**

### Scene 2
**Summary:**
**Characters:**
**Setting:**
**Mood:**
```

3. `useUpdateOutline()` — mutation that updates content and updated_at. Invalidates outline query.

4. `useOutlineReferences(storyId: string | null)` — query that:
   - Fetches the outline content for the story
   - Fetches all library items (characters + settings)
   - Also fetches story_items for the story (forked items count too)
   - Runs `detectLibraryReferences()` on the outline text against all library item names
   - Returns the references array
   - Stale time: 10s (don't recompute on every keystroke — debounce via stale time)
  </action>
  <verify>
`npm run build` passes. Reference detection correctly finds character names in sample text with word boundaries. No false positives for substrings (e.g., "Sam" should not match "same").
  </verify>
  <done>Outline CRUD works via SQLite. Reference detection identifies library item mentions with word-boundary accuracy. Hooks ready for UI integration.</done>
</task>

<task type="auto">
  <name>Task 2: Outline editor UI component</name>
  <files>src/components/library/OutlineEditor.tsx, src/components/library/OutlineEditor.css</files>
  <action>
Create `src/components/library/OutlineEditor.tsx`:

This component renders within the story view in the left pane (when a story is active). It shows:

1. **"Edit Outline" button** — when clicked, loads the outline into the right pane textarea with contentId `outline-{storyId}`. If no outline exists yet, creates one first.

2. **Reference summary panel** — below the button, shows auto-detected references:
   - "Characters mentioned: Alex (3), Jordan (1)"
   - "Settings mentioned: Coffee Shop (2)"
   - Each reference is clickable → navigates to that library item
   - Uses `useOutlineReferences()` hook
   - Shows "No references detected" if outline has no library item mentions

3. **Outline status** — shows "No outline yet" or "Last edited: {date}"

Style with dark theme. The component is compact (designed for left pane space). References are displayed as a small section with colored chips (blue for characters, green for settings — matching the existing context viz color scheme).

Note: This component will be integrated into the StoryList's story detail view in Plan 02-08. For now, export it as a standalone component that accepts `storyId: string` as a prop.

The actual outline editing happens in the textarea (right pane) — this component just provides the navigation and reference display in the left pane.
  </action>
  <verify>
`npm run build` passes. OutlineEditor renders reference chips. Clicking "Edit Outline" loads outline content into textarea (when wired up).
  </verify>
  <done>OutlineEditor component shows reference summary and provides entry point to outline editing. Auto-detected references display as colored chips with occurrence counts.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Reference detection: "Alex went to the Coffee Shop" with characters=[{name:"Alex"}] and settings=[{name:"Coffee Shop"}] → detects both
- Reference detection: "The same thing" with characters=[{name:"Sam"}] → does NOT detect (word boundary prevents "sam" matching "same")
- Outline CRUD persists to SQLite
- OutlineEditor renders with dark theme styling
</verification>

<success_criteria>
Story outlines editable as markdown in the textarea. Library item references auto-detected with word-boundary accuracy. SETUP-02 requirement (chapter/scene outline with beat structure) satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/02-creative-library-story-setup/02-04-SUMMARY.md`
</output>
