---
phase: 02-creative-library-story-setup
plan: 05
type: execute
wave: 3
depends_on: ["02-01"]
files_modified:
  - src/hooks/use-ai-configs.ts
  - src/hooks/use-templates.ts
  - src/components/library/AIConfigList.tsx
  - src/components/library/AIConfigList.css
  - src/components/library/TemplateList.tsx
  - src/components/library/TemplateList.css
autonomous: true

must_haves:
  truths:
    - "User can view and edit global AI config files as markdown in the textarea"
    - "User can create per-story AI config overrides"
    - "User can view and edit templates for characters, settings, and other content types"
    - "AI config files define writing style, tone, and behavior using markdown"
    - "Templates tab lists all available templates with create/edit/delete"
  artifacts:
    - path: "src/hooks/use-ai-configs.ts"
      provides: "CRUD for AI configuration files"
      exports: ["useAIConfigs", "useCreateAIConfig", "useUpdateAIConfig"]
    - path: "src/hooks/use-templates.ts"
      provides: "CRUD for content templates"
      exports: ["useTemplates", "useCreateTemplate", "useUpdateTemplate"]
    - path: "src/components/library/AIConfigList.tsx"
      provides: "AI Config tab content with list and editing"
    - path: "src/components/library/TemplateList.tsx"
      provides: "Templates tab content with template management"
  key_links:
    - from: "src/hooks/use-ai-configs.ts"
      to: "src/services/db.ts"
      via: "SQLite queries"
      pattern: "getDatabase"
    - from: "src/hooks/use-templates.ts"
      to: "src/services/db.ts"
      via: "SQLite queries"
      pattern: "getDatabase"
---

<objective>
Build AI config management and template system. Users create and edit AI behavior config files (global + per-story) as markdown, and manage templates for characters, settings, and other content types. All editing happens in the textarea.

Purpose: Satisfies LIB-04 (themes and tonal elements that guide AI writing style) via the AI config system. Templates enable the customizable character/setting creation workflow.
Output: AI Config tab, Templates tab, CRUD for both, textarea-based editing.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creative-library-story-setup/02-CONTEXT.md
@.planning/phases/02-creative-library-story-setup/02-01-SUMMARY.md
@src/types/index.ts
@src/services/db.ts
@src/services/markdown.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI config and template CRUD hooks</name>
  <files>src/hooks/use-ai-configs.ts, src/hooks/use-templates.ts</files>
  <action>
Create `src/hooks/use-ai-configs.ts` — TanStack Query hooks:

1. `useAIConfigs(storyId?: string)` — query AI configs. If storyId provided, returns story-specific configs. If omitted, returns global configs (is_global=1). Polls every 5s.

2. `useAIConfig(id: string | null)` — single config by ID. Disabled when null.

3. `useCreateAIConfig()` — mutation that creates an ai_configs row:
   - Takes { name, isGlobal, storyId? }
   - Default content for a new config:
```markdown
---
name: "{name}"
stage: "general"
---

# Writing Style

(Define the AI's writing approach here)

## Tone

## Voice

## Avoid
```
   - Invalidates queries

4. `useUpdateAIConfig()` — mutation: updates content and name (re-extract from frontmatter), updated_at. Invalidates queries.

5. `useDeleteAIConfig()` — mutation: delete by ID. Prevent deleting the seeded default global config (is_builtin equivalent — actually there's no is_builtin on ai_configs, but the seeded one has name="Default". Allow deletion of any user-created config).

Create `src/hooks/use-templates.ts` — TanStack Query hooks:

1. `useTemplates(type?: TemplateType)` — query templates, optionally filtered by type. Polls every 5s.

2. `useTemplate(id: string | null)` — single template by ID.

3. `useCreateTemplate()` — mutation that creates a template row:
   - Takes { type, name }
   - Default content: minimal YAML frontmatter with type-appropriate fields + empty markdown body
   - is_builtin = 0 (user-created)
   - Invalidates queries

4. `useUpdateTemplate()` — mutation: updates content, name (from frontmatter), updated_at.

5. `useDeleteTemplate()` — mutation: delete by ID. Prevent deleting builtin templates (is_builtin=1).
  </action>
  <verify>
`npm run build` passes. Hooks are importable. CRUD operations work against SQLite.
  </verify>
  <done>AI config and template CRUD hooks operational. Can create/read/update/delete configs and templates with SQLite persistence.</done>
</task>

<task type="auto">
  <name>Task 2: AI Config and Templates tab UI components</name>
  <files>src/components/library/AIConfigList.tsx, src/components/library/AIConfigList.css, src/components/library/TemplateList.tsx, src/components/library/TemplateList.css</files>
  <action>
Create `src/components/library/AIConfigList.tsx`:
- Two sections: "Global Configs" and "Story Configs" (if a story is active from story-store)
- Uses `useAIConfigs()` for global, `useAIConfigs(activeStoryId)` for story-specific
- "New Config" button that creates a config (prompts for name via inline input)
- Each config shows: name, stage badge (from frontmatter), global/story indicator
- Click → loads config markdown into textarea with contentId `ai-config-{id}`
- Delete button (not on the seeded default)
- "Duplicate" option to create a story-specific copy of a global config (fork pattern: copies content, sets is_global=0, sets story_id)
- Style: dark theme matching existing components

Create `src/components/library/TemplateList.tsx`:
- Groups templates by type: Character, Setting, Theme, Outline, AI Config
- Uses `useTemplates()` without type filter to get all, then groups in component
- "New Template" button with type selector (dropdown or radio)
- Each template shows: name, type badge, builtin indicator
- Click → loads template markdown into textarea with contentId `template-{id}`
- Builtin templates show a "Built-in" badge and cannot be deleted
- User templates have edit and delete
- Style: dark theme, grouped sections with headings

Both components are standalone exports — will be wired into App.tsx tabs in Plan 02-08.
  </action>
  <verify>
`npm run build` passes. Both components render correctly with dark theme. Config and template lists populate from SQLite data.
  </verify>
  <done>AI Config tab shows global and per-story configs with CRUD. Templates tab shows grouped templates with type indicators. Both load content into textarea on click.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- AI config CRUD: create, edit (via textarea), delete
- Template CRUD: create, edit (via textarea), delete (non-builtin only)
- Global configs persist across sessions
- Story-specific configs linked to active story
- Templates grouped by type in the list
</verification>

<success_criteria>
AI behavior configuration editable as markdown files (global + per-story). Template system allows customization of character/setting creation templates. LIB-04 requirement (themes/tonal elements guiding AI) satisfied via the AI config system.
</success_criteria>

<output>
After completion, create `.planning/phases/02-creative-library-story-setup/02-05-SUMMARY.md`
</output>
