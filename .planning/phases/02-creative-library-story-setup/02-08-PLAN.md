---
phase: 02-creative-library-story-setup
plan: 08
type: execute
wave: 5
depends_on: ["02-02", "02-03", "02-04", "02-05", "02-06", "02-07"]
files_modified:
  - src/App.tsx
  - src/components/textarea/EnhancedTextarea.tsx
autonomous: false

must_haves:
  truths:
    - "All five tabs visible: Stories | Characters | Settings | Templates | AI Config"
    - "Clicking any library item loads its markdown into the textarea"
    - "Marker highlighting active in the textarea for all content types"
    - "Process button visible and functional when markers are present"
    - "Story setup workflow: create story → premise → outline → library items"
    - "Context injection: library items automatically available for generation context"
    - "Library items persist, edit, and display correctly across all tabs"
  artifacts:
    - path: "src/App.tsx"
      provides: "Full Phase 2 tab wiring and content routing"
      contains: "Stories.*Characters.*Settings.*Templates.*AI Config"
    - path: "src/components/textarea/EnhancedTextarea.tsx"
      provides: "Textarea with marker highlighting extension enabled"
      contains: "markerHighlighting"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/library/StoryList.tsx"
      via: "tab content"
      pattern: "StoryList"
    - from: "src/App.tsx"
      to: "src/components/library/CharacterList.tsx"
      via: "tab content"
      pattern: "CharacterList"
    - from: "src/App.tsx"
      to: "src/components/markers/MarkerControls.tsx"
      via: "right pane header"
      pattern: "MarkerControls"
    - from: "src/components/textarea/EnhancedTextarea.tsx"
      to: "src/extensions/codemirror/marker-highlighting.ts"
      via: "extension array"
      pattern: "markerHighlighting"
---

<objective>
Wire all Phase 2 components into the application. Connect all five tabs, integrate marker highlighting into the textarea, add the Process button, and verify the complete end-to-end workflow.

Purpose: Integration plan that brings together all Phase 2 features into a working application. This is where the split-screen layout becomes fully functional with all content types.
Output: Complete Phase 2 application with all tabs, textarea integration, marker processing, and story setup workflow.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creative-library-story-setup/02-CONTEXT.md
@.planning/phases/02-creative-library-story-setup/02-02-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-03-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-04-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-05-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-06-SUMMARY.md
@.planning/phases/02-creative-library-story-setup/02-07-SUMMARY.md
@src/App.tsx
@src/components/textarea/EnhancedTextarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full tab wiring and textarea integration</name>
  <files>src/App.tsx, src/components/textarea/EnhancedTextarea.tsx</files>
  <action>
**Modify `src/components/textarea/EnhancedTextarea.tsx`:**
- Import `markerHighlighting` from `@/extensions/codemirror/marker-highlighting`
- Add it to the CodeMirror extensions array so markers are highlighted in ALL content types

**Rewrite `src/App.tsx` tab system:**

Replace the existing two-tab setup (Generation, Settings) with the full five-tab layout:

```typescript
const tabs: TabDefinition[] = [
  { id: 'stories', label: 'Stories', content: <StoryList /> },
  { id: 'characters', label: 'Characters', content: <CharacterList /> },
  { id: 'settings', label: 'Settings', content: <SettingList /> },
  { id: 'templates', label: 'Templates', content: <TemplateList /> },
  { id: 'ai-config', label: 'AI Config', content: <AIConfigList /> },
];
```

Keep the existing Generation and Settings (app settings) tabs accessible — move them:
- Generation stays accessible via the Stories tab (when a story is active and in writing mode)
- App Settings (LLM connection config) → accessible via a gear icon or header button, not as a main tab

**RightPaneContent routing logic:**

The right pane needs to show different content based on what's active:

1. If a library item is active (from library-store) → EnhancedTextarea with contentId=`library-{id}`
2. If a story item (forked) is active (from story-store) → EnhancedTextarea with contentId=`story-item-{id}`
3. If an outline is active → EnhancedTextarea with contentId=`outline-{storyId}`
4. If an AI config is active → EnhancedTextarea with contentId=`ai-config-{id}`
5. If a template is active → EnhancedTextarea with contentId=`template-{id}`
6. If premise workspace is active → EnhancedTextarea with contentId=`premise-{storyId}` + vertical split with context viz below
7. If generation tab is active (from story in writing mode) → existing generation workspace layout
8. Default: empty state with instructions

Add a shared "active content" concept. Create a simple routing store or extend ui-store:
```typescript
interface ActiveContent {
  type: 'library' | 'story-item' | 'outline' | 'ai-config' | 'template' | 'premise' | 'generation' | null;
  id: string | null;
  contentId: string | null;
}
```

Each list component (CharacterList, SettingList, StoryList, etc.) sets the active content when an item is clicked.

**MarkerControls integration:**
- Add MarkerControls as a toolbar above the textarea when editing library items, outlines, or story items
- Pass the necessary props: current content, update callback, library items for lookups

**Settings access:**
- Add a small gear icon in the top-right header area that opens the existing SettingsPanel in a modal or slide-over panel
- This replaces the Settings tab from Phase 1 (app LLM settings are not a main tab in Phase 2)

Import all new components at the top of App.tsx.
  </action>
  <verify>
`npm run build` passes. All five tabs render in left pane. Clicking items loads content into textarea. Marker highlighting visible. MarkerControls toolbar appears above textarea.
  </verify>
  <done>All Phase 2 components wired into the application. Five tabs visible. Right pane routes content correctly. Marker highlighting active. Settings accessible via gear icon.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end Phase 2 verification</name>
  <files>none</files>
  <action>
Human verification checkpoint for the complete Phase 2 integration. No code changes — verification only.

What was built: Complete Phase 2: Creative Library + Story Setup. All five tabs (Stories, Characters, Settings, Templates, AI Config) with full CRUD, AI-assisted premise refinement, outline editing, marker processing, and library forking/merging.

How to verify:
1. Navigate tabs — verify all five tabs are visible and clickable in the left pane
2. Create a character — go to Characters tab, click "New Character", verify template loads in textarea with YAML frontmatter
3. Edit the character — fill in name, traits, backstory. Wait for auto-save. Refresh page — verify changes persist
4. Create a setting — go to Settings tab, create a new setting. Edit its frontmatter and notes
5. Create a story — go to Stories tab, click "New Story", enter a title
6. Premise refinement — in the story, start writing a premise. Click "Send" to get AI response (requires LLM connection). Verify adaptive conversation
7. Extract assets — after developing the premise, click "Extract Assets". Verify characters/settings are parsed and can be accepted into the library
8. Edit outline — click "Edit Outline" in the story view. Verify outline loads in textarea. Add character names — verify auto-detection shows them in the reference panel
9. Fork a library item — add a character to the story. Verify it creates a story-local copy
10. Test markers — in any document, type {{character:Alex}} and verify it highlights in blue. Type {{expand:describe the scene}} and verify amber highlight
11. Process markers — click "Process" button. Verify markers are resolved (character refs replaced with profile content, expand markers generate text via LLM)
12. Templates — go to Templates tab, verify built-in templates are listed. Create a custom template
13. AI Config — go to AI Config tab, verify default config exists. Edit it. Create a per-story config
14. App settings — verify gear icon opens LLM connection settings

Resume signal: Type "approved" if all workflows function correctly, or describe issues found.
  </action>
  <verify>Human approval received</verify>
  <done>All Phase 2 workflows verified by human testing. Application functions end-to-end.</done>
</task>

</tasks>

<verification>
- All five tabs visible and functional
- Character and setting CRUD with template-based creation
- Story creation and premise refinement workflow
- Outline editing with auto-detected library references
- Library item forking and update detection
- Marker highlighting in textarea for all content types
- Marker processing resolves references and generates content
- Templates and AI configs manageable
- App settings accessible
- All data persists across page refresh
</verification>

<success_criteria>
Complete Phase 2 integration verified by human testing. All requirements satisfied:
- LIB-01: Character profiles with structured fields ✓
- LIB-02: Setting/location entries with atmosphere details ✓
- LIB-03: Library reuse across stories with forking ✓
- LIB-04: Themes/tonal elements via AI config ✓
- SETUP-01: Premise refinement through AI conversation ✓
- SETUP-02: Chapter/scene outline with beat structure ✓
- SETUP-03: Collaborative building during setup ✓
</success_criteria>

<output>
After completion, create `.planning/phases/02-creative-library-story-setup/02-08-SUMMARY.md`
</output>
