---
phase: 01-foundation-context-engine
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/textarea/EnhancedTextarea.tsx
  - src/App.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Generation output renders in EnhancedTextarea with CodeMirror, not a plain <pre> element"
    - "Streaming LLM output appears in the textarea in real-time as tokens arrive"
    - "After generation completes, user can edit text inline and edits are auto-saved as versions"
    - "Ctrl+S creates explicit manual save points during editing"
  artifacts:
    - path: "src/components/textarea/EnhancedTextarea.tsx"
      provides: "Controlled mode via externalValue prop for streaming updates"
      contains: "externalValue"
    - path: "src/App.tsx"
      provides: "Generation output wired through EnhancedTextarea"
      contains: "EnhancedTextarea"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/textarea/EnhancedTextarea.tsx"
      via: "externalValue={currentOutput} prop"
      pattern: "externalValue.*currentOutput"
    - from: "src/components/textarea/EnhancedTextarea.tsx"
      to: "src/hooks/use-auto-save.ts"
      via: "Auto-save hook tracks inline edits"
      pattern: "useAutoSave"
---

<objective>
Replace the plain `<pre>` element for generation output with EnhancedTextarea, enabling inline editing and version tracking of generated text.

Purpose: Gap 1 from VERIFICATION.md — generation output must use EnhancedTextarea (with contentId='generation-output') so users can edit generated text inline with changes tracked as versions. The current `<pre>` element is read-only and bypasses the version system entirely.

Output: EnhancedTextarea that accepts external value updates (for streaming) while supporting local edits (for post-generation editing), wired into App.tsx replacing the `<pre>` block.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-context-engine/01-03-SUMMARY.md
@.planning/phases/01-foundation-context-engine/01-06-SUMMARY.md
@src/components/textarea/EnhancedTextarea.tsx
@src/stores/generation-store.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add controlled external value support to EnhancedTextarea</name>
  <files>src/components/textarea/EnhancedTextarea.tsx</files>
  <action>
Add an optional `externalValue` prop to EnhancedTextarea. When provided, the component operates in "controlled" mode where external updates (e.g., streaming LLM output) push content into the editor.

Specific changes to `EnhancedTextarea.tsx`:

1. Add `externalValue?: string` to `EnhancedTextareaProps` interface.

2. Add `onEdit?: (value: string) => void` callback prop — fires when user edits content (distinct from external value changes). This lets the parent distinguish user edits from streaming updates.

3. Replace the single `useState(initialValue)` with logic that syncs from externalValue:
   - When `externalValue` changes AND the user is NOT actively editing (isViewingHistory is false and no recent user keystrokes), update the internal value to match externalValue.
   - Use a `useEffect` that watches `externalValue` and sets the internal value when it changes.
   - Track whether the user has made local edits since the last externalValue change using a ref (`userEditedRef`). Reset this ref when externalValue changes.

4. In `handleChange`, set `userEditedRef.current = true` and call `onEdit?.(newValue)` in addition to the existing `onChange?.(newValue)`.

5. When `externalValue` transitions from changing (streaming) to stable (generation complete), the component should continue using the last externalValue as its internal state, allowing the user to edit from that point. The auto-save hook will then track subsequent edits as versions.

Keep the existing behavior intact when `externalValue` is not provided (uncontrolled mode for system-prompt editor and other uses).

Do NOT add any new dependencies. Do NOT change the CodeMirror setup, keymap, or version navigation logic.
  </action>
  <verify>
Run `npm run build` — zero TypeScript errors. The EnhancedTextarea component should accept `externalValue` prop without breaking existing usage (system-prompt textarea in settings tab).
  </verify>
  <done>
EnhancedTextarea accepts optional `externalValue` prop. When provided, external value changes update the editor content. When not provided, existing uncontrolled behavior is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire EnhancedTextarea into App.tsx for generation output</name>
  <files>src/App.tsx</files>
  <action>
Replace the `<pre>` element in App.tsx (lines 87-91) with EnhancedTextarea wired to generation-store.

In the `RightPaneContent` component's generation tab branch (the else block after the settings check):

1. Remove the `<div>` + `<pre>` block that currently renders `currentOutput`.

2. Replace with:
   ```tsx
   <EnhancedTextarea
     contentId="generation-output"
     externalValue={currentOutput}
     placeholder="Generated text will appear here..."
   />
   ```

3. Remove the TODO comment on line 83 ("TODO: Enhance EnhancedTextarea to support external value updates in Phase 2") — this is exactly what we're doing now.

4. The EnhancedTextarea is already imported (line 8). No new imports needed.

5. Keep the Allotment vertical split structure — EnhancedTextarea goes in the top pane, ContextVisualization stays in the bottom pane.

After this change:
- During streaming: `currentOutput` from generation-store updates via `appendToOutput()` → flows to EnhancedTextarea via `externalValue` → editor shows streaming text
- After generation: User edits the text inline in CodeMirror → auto-save creates version entries → Ctrl+S creates manual save points
- Version navigation works for generation-output content just like it does for system-prompt
  </action>
  <verify>
Run `npm run build` — zero errors. Visually confirm (or grep) that no `<pre>` element exists in App.tsx for generation output. Confirm EnhancedTextarea with contentId="generation-output" and externalValue prop is present.
  </verify>
  <done>
App.tsx renders generation output through EnhancedTextarea with externalValue={currentOutput}. No `<pre>` element for generation output. The TODO comment is removed.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `grep -n '<pre>' src/App.tsx` returns no matches (no pre element for generation output)
3. `grep -n 'generation-output' src/App.tsx` shows EnhancedTextarea with contentId
4. `grep -n 'externalValue' src/components/textarea/EnhancedTextarea.tsx` shows the new prop in interface and implementation
5. `grep -n 'externalValue' src/App.tsx` shows it wired to currentOutput
</verification>

<success_criteria>
- EnhancedTextarea renders generation output (not `<pre>`)
- Streaming output flows through externalValue prop in real-time
- Post-generation inline edits trigger auto-save version creation
- Ctrl+S creates manual save points
- Existing system-prompt textarea (uncontrolled mode) still works
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-context-engine/01-07-SUMMARY.md`
</output>
