---
phase: 01-foundation-context-engine
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/App.tsx
  - src/App.css
  - src/components/split-layout/SplitLayout.tsx
  - src/components/split-layout/SplitLayout.css
  - src/components/tabs/TabSystem.tsx
  - src/components/tabs/TabSystem.css
  - src/components/textarea/EnhancedTextarea.tsx
  - src/components/textarea/EnhancedTextarea.css
  - src/components/textarea/VersionNav.tsx
  - src/hooks/use-auto-save.ts
  - src/hooks/use-version-history.ts
autonomous: true

must_haves:
  truths:
    - "App renders a resizable split-screen with left pane (tabs/navigation) and right pane (textarea)"
    - "Left pane has an extensible tab system with 'Generation' and 'Settings' tabs active"
    - "Right pane shows the reusable CodeMirror textarea with markdown syntax highlighting"
    - "Textarea has version navigation (back/forward buttons) connected to SQLite version history"
    - "Auto-save creates versioned snapshots with chunked change tracking on natural pauses"
    - "Ctrl+S / Cmd+S creates an explicit version save point"
  artifacts:
    - path: "src/components/split-layout/SplitLayout.tsx"
      provides: "Allotment-based split pane wrapper"
      exports: ["SplitLayout"]
    - path: "src/components/tabs/TabSystem.tsx"
      provides: "Extensible tab navigation for left pane"
      exports: ["TabSystem", "TabDefinition"]
    - path: "src/components/textarea/EnhancedTextarea.tsx"
      provides: "Reusable CodeMirror textarea with version tracking"
      exports: ["EnhancedTextarea"]
    - path: "src/hooks/use-auto-save.ts"
      provides: "Debounced auto-save hook with chunked change tracking"
      exports: ["useAutoSave"]
    - path: "src/hooks/use-version-history.ts"
      provides: "Version navigation hook backed by SQLite"
      exports: ["useVersionHistory"]
  key_links:
    - from: "src/components/textarea/EnhancedTextarea.tsx"
      to: "src/hooks/use-version-history.ts"
      via: "hook usage for version navigation"
      pattern: "useVersionHistory"
    - from: "src/hooks/use-auto-save.ts"
      to: "src/services/db.ts"
      via: "INSERT INTO versions"
      pattern: "getDatabase.*versions"
    - from: "src/hooks/use-version-history.ts"
      to: "src/services/db.ts"
      via: "SELECT FROM versions"
      pattern: "getDatabase.*versions"
    - from: "src/App.tsx"
      to: "src/components/split-layout/SplitLayout.tsx"
      via: "component composition"
      pattern: "SplitLayout"
---

<objective>
Build the core UI layer: the split-screen layout with Allotment, the extensible tab system for the left pane, and the reusable CodeMirror textarea component with version navigation and auto-save. These are the foundational UI components used by every subsequent plan in this phase and all future phases.

Purpose: The textarea component is the single most important UI element in Storyteller — it's used for generation output, prompt editing, system prompt editing, and in Phase 2+ for all creative library items. The split-screen layout and tab system establish the app's information architecture.

Output: Working split-screen app with tabbed navigation and a version-tracked textarea.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-context-engine/01-CONTEXT.md
@.planning/phases/01-foundation-context-engine/01-RESEARCH.md
@.planning/phases/01-foundation-context-engine/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split-screen layout with Allotment and extensible tab system</name>
  <files>
    src/App.tsx
    src/App.css
    src/components/split-layout/SplitLayout.tsx
    src/components/split-layout/SplitLayout.css
    src/components/tabs/TabSystem.tsx
    src/components/tabs/TabSystem.css
  </files>
  <action>
    **SplitLayout component (src/components/split-layout/SplitLayout.tsx):**
    - Use Allotment for a horizontal split pane
    - Left pane: minSize=250, preferredSize="30%" — receives children for tab system
    - Right pane: flexible, receives children for textarea or other content
    - Import allotment/dist/style.css
    - Props: leftContent (ReactNode), rightContent (ReactNode)
    - Style: full viewport height (100vh), dark-neutral background (Claude's discretion on palette)

    **TabSystem component (src/components/tabs/TabSystem.tsx):**
    - Extensible tab system designed for growth across phases
    - Accept a `tabs` prop: array of TabDefinition objects `{ id: string, label: string, icon?: ReactNode, content: ReactNode }`
    - Render tab bar at top of left pane with tab buttons
    - Render active tab's content below the tab bar
    - Use ui-store's activeTab state for selection
    - Phase 1 tabs: "generation" (Generation workspace — placeholder content for now) and "settings" (Settings — placeholder content for now)
    - Tab buttons should be simple, clean, keyboard-accessible (role="tab", aria-selected)
    - CSS: tab bar is a horizontal row, active tab has a visible indicator (bottom border or background change)

    **Update App.tsx:**
    - Wrap QueryClientProvider (TanStack Query) around the app
    - Render SplitLayout with TabSystem in left pane
    - Right pane: render EnhancedTextarea placeholder (just a div with "Textarea" text until Task 2)
    - Keep the DB initialization logic from Plan 01
    - Show loading skeleton while DB initializes

    **CSS approach:** Use plain CSS files (one per component), no CSS framework. Keep it clean and functional — power-user aesthetic. Use CSS custom properties for theming (dark mode default). Neutral dark palette: dark background (#1a1a2e or similar), light text, subtle borders. Claude has discretion on exact colors.
  </action>
  <verify>
    `npm run build` — no errors.
    Dev server shows split-screen layout with resizable divider.
    Left pane shows tab bar with "Generation" and "Settings" tabs.
    Clicking tabs switches content area in left pane.
    Layout fills full viewport with no scroll bars on the body.
  </verify>
  <done>Split-screen layout renders with resizable panes, tab system switches between Generation and Settings placeholders, layout is full-viewport, and tab infrastructure is extensible for future phases.</done>
</task>

<task type="auto">
  <name>Task 2: Reusable CodeMirror textarea with version navigation and auto-save</name>
  <files>
    src/components/textarea/EnhancedTextarea.tsx
    src/components/textarea/EnhancedTextarea.css
    src/components/textarea/VersionNav.tsx
    src/hooks/use-auto-save.ts
    src/hooks/use-version-history.ts
    src/App.tsx
  </files>
  <action>
    **EnhancedTextarea component (src/components/textarea/EnhancedTextarea.tsx):**
    - Use @uiw/react-codemirror as the editing surface
    - Props: contentId (string — unique ID for version tracking), initialValue (string), onChange (callback), readOnly (boolean, default false), placeholder (string)
    - Extensions array (order matters per research pitfall):
      1. markdown() from @codemirror/lang-markdown
      2. Custom keymap with Mod-s for explicit save
      3. Theme: dark theme consistent with app palette
    - basicSetup config: lineNumbers=false (markdown, not code), foldGutter=true, highlightActiveLine=true
    - Render VersionNav above the editor
    - Component fills its container height (flex: 1)
    - Wire onChange to both the parent callback and the auto-save hook

    **VersionNav component (src/components/textarea/VersionNav.tsx):**
    - Back/forward buttons for browsing version history (not undo/redo — version timeline)
    - Shows "Version X of Y" indicator between buttons
    - When browsing history: textarea shows historical version in read-only mode
    - "Return to current" button when viewing a historical version
    - Buttons disabled when at start/end of history
    - Compact horizontal bar above the editor

    **useAutoSave hook (src/hooks/use-auto-save.ts):**
    - Accepts contentId and current content string
    - Debounces saves: only save after 2 seconds of inactivity (natural pause = chunked change tracking)
    - Prevents duplicate saves: compare with last saved content, skip if identical
    - Serializes saves: if a save is in progress, queue the next one (don't fire concurrent writes)
    - Saves to `versions` table in SQLite with version_type='auto'
    - Returns: { isSaving: boolean, lastSavedAt: number | null }

    **useVersionHistory hook (src/hooks/use-version-history.ts):**
    - Accepts contentId
    - Loads version list from SQLite `versions` table ordered by created_at DESC
    - State: versions array, currentIndex (null = latest/editing mode), isViewingHistory
    - Actions: goBack (older version), goForward (newer version), goToCurrent (exit history browsing)
    - saveManuaVersion(content) — creates a version with version_type='manual' (for Ctrl+S)
    - Returns: { versions, currentVersion, versionCount, currentIndex, isViewingHistory, goBack, goForward, goToCurrent, saveManualVersion }

    **Ctrl+S / Cmd+S behavior:**
    - Triggers saveManualVersion through the CodeMirror keymap extension
    - Creates a version_type='manual' entry (distinct from auto-save entries)
    - Prevents default browser save dialog

    **Update App.tsx:**
    - Replace right pane placeholder with EnhancedTextarea
    - Use a default contentId like 'scratch' for the initial workspace
    - Connect textarea to TanStack Query for version history loading
  </action>
  <verify>
    `npm run build` — no errors.
    Type in the textarea — markdown syntax highlights correctly.
    Wait 2+ seconds after typing — auto-save fires (check SQLite via console or by refreshing and seeing content persist).
    Press Ctrl+S — explicit save point created.
    Click version back/forward — textarea shows historical versions.
    Version nav shows "Version X of Y" correctly.
  </verify>
  <done>CodeMirror textarea renders with markdown highlighting, auto-save creates versions after natural pauses, Ctrl+S creates explicit save points, version navigation browses through history, and the component is reusable with any contentId.</done>
</task>

</tasks>

<verification>
1. `npm run build` — zero errors
2. Split-screen layout is resizable, fills viewport
3. Tab system switches between Generation and Settings tabs
4. CodeMirror textarea has markdown syntax highlighting
5. Auto-save fires after 2s of inactivity, creates version in SQLite
6. Ctrl+S creates manual version
7. Version nav back/forward browses through saved versions
8. Refreshing the page restores content (versions persisted in SQLite)
</verification>

<success_criteria>
- Resizable split-screen with Allotment working
- Tab system renders Generation and Settings tabs, extensible for Phase 2+
- CodeMirror textarea with markdown highlighting in right pane
- Version navigation (back/forward) functional
- Auto-save with 2s debounce creating versions in SQLite
- Ctrl+S/Cmd+S explicit save points
- All components reusable (contentId-based version tracking)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-context-engine/01-03-SUMMARY.md`
</output>
