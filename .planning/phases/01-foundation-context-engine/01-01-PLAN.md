---
phase: 01-foundation-context-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tsconfig.app.json
  - tsconfig.node.json
  - vite.config.ts
  - index.html
  - public/sqlite-wasm/sqlite3.mjs
  - public/sqlite-wasm/sqlite3.wasm
  - src/main.tsx
  - src/App.tsx
  - src/App.css
  - src/services/db.ts
  - src/stores/settings-store.ts
  - src/stores/ui-store.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Vite dev server starts and serves the app at localhost with COOP/COEP headers"
    - "SQLite WASM initializes with OPFS backend and creates all schema tables"
    - "Settings store persists LLM connection config across page refreshes"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite config with COOP/COEP headers and React plugin"
      contains: "Cross-Origin-Opener-Policy"
    - path: "src/services/db.ts"
      provides: "SQLite WASM initialization and schema"
      exports: ["getDatabase", "initDatabase"]
    - path: "src/stores/settings-store.ts"
      provides: "Zustand store for LLM connection settings"
      exports: ["useSettingsStore"]
    - path: "src/types/index.ts"
      provides: "Shared TypeScript types for the entire app"
  key_links:
    - from: "src/services/db.ts"
      to: "public/sqlite-wasm/sqlite3.mjs"
      via: "dynamic import"
      pattern: "sqlite3InitModule"
    - from: "src/stores/settings-store.ts"
      to: "localStorage"
      via: "zustand persist middleware"
      pattern: "persist.*storyteller-settings"
---

<objective>
Scaffold the Storyteller project with Vite + React + TypeScript, install all dependencies, configure the build system with required COOP/COEP headers for SQLite WASM, initialize the SQLite WASM database with the full application schema, and set up Zustand state management stores.

Purpose: Establish the foundational infrastructure that every subsequent plan depends on — build tooling, persistence layer, and state management. Nothing else can be built until the project exists and the database is ready.

Output: A running Vite dev server with SQLite WASM initialized, database schema created, and Zustand stores configured.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-context-engine/01-CONTEXT.md
@.planning/phases/01-foundation-context-engine/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Vite + React + TypeScript project with all dependencies</name>
  <files>
    package.json
    tsconfig.json
    tsconfig.app.json
    tsconfig.node.json
    vite.config.ts
    index.html
    src/main.tsx
    src/App.tsx
    src/App.css
  </files>
  <action>
    Initialize the project using `npm create vite@latest . -- --template react-ts` (use `.` since we're already in the storyteller directory).

    Install all production dependencies:
    ```
    npm install @uiw/react-codemirror @codemirror/lang-markdown
    npm install openai js-tiktoken
    npm install zustand @tanstack/react-query
    npm install allotment react-markdown immer clsx
    ```

    Install dev dependencies:
    ```
    npm install --save-dev @types/react @types/react-dom @vitejs/plugin-react
    ```

    Configure vite.config.ts:
    - Add React plugin
    - Add COOP/COEP headers for SharedArrayBuffer (required for SQLite WASM OPFS):
      - `Cross-Origin-Opener-Policy: same-origin`
      - `Cross-Origin-Embedder-Policy: require-corp`
    - Add path alias: `@` -> `/src`
    - These headers are CRITICAL — SQLite WASM OPFS will silently fail without them

    Configure tsconfig.app.json:
    - Add path alias: `"@/*": ["./src/*"]`

    Update index.html title to "Storyteller".

    Create minimal src/App.tsx that renders a "Storyteller" heading (placeholder for layout in Plan 03).

    Create src/App.css with a minimal CSS reset (box-sizing, margin, height: 100vh on body).

    Verify: `npm run dev` starts without errors and `npm run build` succeeds.
  </action>
  <verify>
    Run `npm run build` — must complete with zero errors.
    Run `npm run dev` in background, then `curl -sI http://localhost:5173` — response must include both COOP and COEP headers.
  </verify>
  <done>Vite dev server runs, TypeScript compiles clean, COOP/COEP headers present in dev server responses, all dependencies installed.</done>
</task>

<task type="auto">
  <name>Task 2: Initialize SQLite WASM with OPFS, create database schema, and set up Zustand stores</name>
  <files>
    public/sqlite-wasm/sqlite3.mjs
    public/sqlite-wasm/sqlite3.wasm
    src/services/db.ts
    src/stores/settings-store.ts
    src/stores/ui-store.ts
    src/types/index.ts
  </files>
  <action>
    **SQLite WASM setup:**
    Download the official SQLite WASM release from https://sqlite.org/download.html (the `sqlite-wasm-*.zip` file). Extract `jswasm/sqlite3.mjs` and `jswasm/sqlite3.wasm` into `public/sqlite-wasm/`. If download fails or is impractical, use the npm package `@aspect-build/aspect-for-js` approach — but prefer the official distribution per research recommendation.

    Alternative approach if direct download is problematic: install `@aspect-build/aspect-for-js` or use the `@sqlite.org/sqlite-wasm` npm package and configure Vite to serve the WASM files from node_modules. The key requirement is that sqlite3.wasm is served with the correct MIME type and COOP/COEP headers are present.

    **Create src/types/index.ts** with shared types:
    ```typescript
    // Database record types
    export interface Version {
      id: number;
      content_id: string;
      content: string;
      version_type: 'auto' | 'manual' | 'generation';
      created_at: number;
    }

    export interface Generation {
      id: number;
      prompt: string;
      output: string;
      model: string;
      parameters: string; // JSON string of generation params
      token_count: number;
      created_at: number;
    }

    export interface Preset {
      id: number;
      name: string;
      temperature: number;
      max_tokens: number;
      top_p: number;
      frequency_penalty: number;
      presence_penalty: number;
      is_builtin: boolean;
    }

    export interface CompressionEvent {
      id: number;
      source_tier: string;
      target_tier: string;
      original_tokens: number;
      compressed_tokens: number;
      summary_text: string;
      created_at: number;
    }

    // Context engine types
    export interface ContextTier {
      label: string;
      content: string;
      tokens: number;
      priority: number;
      color: string;
    }

    // LLM types
    export interface LLMSettings {
      baseURL: string;
      apiKey: string;
      model: string;
    }

    export interface GenerationParams {
      temperature: number;
      maxTokens: number;
      topP: number;
      frequencyPenalty: number;
      presencePenalty: number;
    }
    ```

    **Create src/services/db.ts:**
    - Export `initDatabase()` — initializes SQLite WASM with OPFS backend, creates schema
    - Export `getDatabase()` — returns initialized DB instance (singleton pattern with lazy init)
    - Schema tables:
      - `versions` (id INTEGER PK, content_id TEXT NOT NULL, content TEXT NOT NULL, version_type TEXT DEFAULT 'auto', created_at INTEGER NOT NULL)
      - `generations` (id INTEGER PK, prompt TEXT NOT NULL, output TEXT NOT NULL, model TEXT NOT NULL, parameters TEXT, token_count INTEGER DEFAULT 0, created_at INTEGER NOT NULL)
      - `presets` (id INTEGER PK, name TEXT NOT NULL UNIQUE, temperature REAL, max_tokens INTEGER, top_p REAL, frequency_penalty REAL, presence_penalty REAL, is_builtin INTEGER DEFAULT 0)
      - `compression_events` (id INTEGER PK, source_tier TEXT NOT NULL, target_tier TEXT NOT NULL, original_tokens INTEGER NOT NULL, compressed_tokens INTEGER NOT NULL, summary_text TEXT, created_at INTEGER NOT NULL)
    - Seed built-in presets on first run: Creative (temp=1.0, max_tokens=2048, top_p=0.95, freq=0.0, pres=0.0), Balanced (temp=0.7, max_tokens=2048, top_p=0.9, freq=0.3, pres=0.3), Precise (temp=0.3, max_tokens=2048, top_p=0.8, freq=0.5, pres=0.5)
    - Add CREATE INDEX on versions(content_id), generations(created_at)
    - Handle OPFS fallback: check `navigator.storage?.getDirectory` exists; if not, fall back to non-persistent memory DB with console warning

    **Create src/stores/settings-store.ts:**
    - Zustand store with `persist` middleware using localStorage
    - State: baseURL (default: 'http://localhost:1234/v1'), apiKey (default: ''), model (default: ''), connectionStatus ('disconnected' | 'connected' | 'error'), availableModels (string[])
    - Actions: updateSettings, setConnectionStatus, setAvailableModels

    **Create src/stores/ui-store.ts:**
    - Zustand store (no persistence needed)
    - State: activeTab (string, default: 'generation'), leftPaneWidth (number), contextVizExpanded (boolean)
    - Actions: setActiveTab, setLeftPaneWidth, setContextVizExpanded

    Update src/App.tsx to call `initDatabase()` on mount (inside useEffect) and show a loading state while DB initializes. Use React.Suspense or a simple loading boolean.
  </action>
  <verify>
    Run `npm run build` — must compile with no TypeScript errors.
    Run the dev server — open browser console, verify no SQLite WASM initialization errors.
    Check that the Zustand settings store saves and restores from localStorage (set a value, refresh, value persists).
  </verify>
  <done>SQLite WASM initializes with OPFS (or fallback), all schema tables created with correct columns and indexes, built-in presets seeded, Zustand stores functional with persistence, types exported for use by other plans.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes with zero errors
2. `npm run dev` serves the app with COOP/COEP headers
3. Browser console shows successful SQLite WASM initialization (no SharedArrayBuffer errors)
4. Database tables exist and built-in presets are queryable
5. Settings store persists across page refresh
</verification>

<success_criteria>
- Vite dev server running with correct COOP/COEP headers
- All dependencies installed and importable
- SQLite WASM initialized with OPFS backend (or graceful fallback)
- Database schema with versions, generations, presets, compression_events tables
- Three built-in presets seeded (Creative, Balanced, Precise)
- Zustand stores configured for settings (persisted) and UI state
- TypeScript types shared across the application
- `npm run build` produces zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-context-engine/01-01-SUMMARY.md`
</output>
