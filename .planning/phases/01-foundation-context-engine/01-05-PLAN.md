---
phase: 01-foundation-context-engine
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/components/context-viz/ContextVisualization.tsx
  - src/components/context-viz/ContextVisualization.css
  - src/components/context-viz/ContextBar.tsx
  - src/components/context-viz/ContextItemList.tsx
  - src/components/context-viz/ContextInspector.tsx
  - src/components/context-viz/CompressionLog.tsx
  - src/hooks/use-compression-log.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Always-visible context visualization panel shows a stacked bar with color-coded segments"
    - "Each segment represents a context category (system prompt, recent text, compressed history, etc.)"
    - "Expandable itemized list shows each category with label, token count, and progress bar"
    - "Clicking any category opens full text inspection of the exact content packed into the LLM call"
    - "Compression event log shows when content moves between tiers with token counts"
  artifacts:
    - path: "src/components/context-viz/ContextVisualization.tsx"
      provides: "Main context visualization container"
      exports: ["ContextVisualization"]
    - path: "src/components/context-viz/ContextBar.tsx"
      provides: "Stacked horizontal bar with color-coded segments"
      exports: ["ContextBar"]
    - path: "src/components/context-viz/ContextItemList.tsx"
      provides: "Expandable itemized list of context categories"
      exports: ["ContextItemList"]
    - path: "src/components/context-viz/ContextInspector.tsx"
      provides: "Full text inspection panel for a context category"
      exports: ["ContextInspector"]
    - path: "src/components/context-viz/CompressionLog.tsx"
      provides: "Compression event log"
      exports: ["CompressionLog"]
    - path: "src/hooks/use-compression-log.ts"
      provides: "Hook to read/write compression events from SQLite"
      exports: ["useCompressionLog"]
  key_links:
    - from: "src/components/context-viz/ContextVisualization.tsx"
      to: "src/services/context-engine.ts"
      via: "Receives ContextTier[] from context engine"
      pattern: "ContextTier"
    - from: "src/hooks/use-compression-log.ts"
      to: "src/services/db.ts"
      via: "SELECT FROM compression_events"
      pattern: "getDatabase.*compression_events"
    - from: "src/components/context-viz/ContextInspector.tsx"
      to: "react-markdown"
      via: "Render markdown content in inspection view"
      pattern: "ReactMarkdown"
---

<objective>
Build the context visualization panel — the user's window into what the LLM sees. This is an always-visible panel showing a stacked bar of context segments, an expandable itemized breakdown with token counts, full text inspection for each category, and a compression event log. It connects to the context engine (Plan 02) for data and the UI layout (Plan 03) for rendering position.

Purpose: Transparency is a core design principle (per user decision: "feel like a debugger/inspector for the LLM call"). Users need to see exactly what content enters each generation call, understand the token budget allocation, and observe compression events to build confidence the system works.

Output: Context visualization components ready to receive live data from the generation workspace.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-context-engine/01-CONTEXT.md
@.planning/phases/01-foundation-context-engine/01-RESEARCH.md
@.planning/phases/01-foundation-context-engine/01-02-SUMMARY.md
@.planning/phases/01-foundation-context-engine/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Context visualization panel with stacked bar, itemized list, and text inspection</name>
  <files>
    src/components/context-viz/ContextVisualization.tsx
    src/components/context-viz/ContextVisualization.css
    src/components/context-viz/ContextBar.tsx
    src/components/context-viz/ContextItemList.tsx
    src/components/context-viz/ContextInspector.tsx
  </files>
  <action>
    **ContextVisualization (src/components/context-viz/ContextVisualization.tsx):**
    - Always-visible panel (per user decision — not on-demand or generation-only)
    - Position: below the textarea in the right pane, or as a bottom panel in the split layout. Use a vertical split within the right pane: textarea on top (flex: 1), context viz on bottom (fixed height ~200px, resizable)
    - Props: segments (ContextTier[]), maxTokens (number), compressionEvents (CompressionEvent[])
    - Renders ContextBar at top, then expandable ContextItemList, then CompressionLog
    - Total token count display: "X / Y tokens (Z%)"
    - When no segments provided (no generation yet): show an empty state message ("Generate text to see context breakdown")

    **ContextBar (src/components/context-viz/ContextBar.tsx):**
    - Single horizontal stacked bar
    - Each segment: width proportional to tokens/maxTokens, background color from tier's color property
    - Tooltip on hover: "Label: X tokens (Y%)"
    - Remaining (unused) capacity shown as empty/gray segment
    - Min segment width: 2px (so tiny segments are still visible)
    - Bar height: ~24px, rounded corners, subtle border

    Color scheme for standard tiers (Claude's discretion but consistent):
    - System Prompt: blue (#4a9eff)
    - Recent Text: green (#4ade80)
    - Compressed History: amber (#fbbf24)
    - Story Outline: purple (#a78bfa) — used in Phase 2+
    - Long-term Summary: red-orange (#fb923c)
    - Unused: dark gray (#333)

    **ContextItemList (src/components/context-viz/ContextItemList.tsx):**
    - Expandable section below the bar (toggle button: "Show Details" / "Hide Details")
    - Each context category as a row:
      - Color dot (matching bar segment)
      - Label text
      - Token count (e.g., "342 tokens")
      - Percentage of total
      - Small progress bar (width = tokens/maxTokens)
      - "Inspect" button to open full text view
    - Sorted by priority (highest first, matching bar order)

    **ContextInspector (src/components/context-viz/ContextInspector.tsx):**
    - Modal or slide-over panel showing full text content of a selected category
    - Header: category label + token count + close button
    - Body: render content using react-markdown for formatted display (since all content is markdown)
    - Scrollable if content is long
    - Keyboard accessible: Escape to close
  </action>
  <verify>
    `npm run build` — no errors.
    Render ContextVisualization with sample data:
    ```
    segments = [
      { label: 'System Prompt', content: 'You are...', tokens: 50, priority: 100, color: '#4a9eff' },
      { label: 'Recent Text', content: 'The story...', tokens: 200, priority: 90, color: '#4ade80' },
      { label: 'History', content: 'Summary...', tokens: 100, priority: 50, color: '#fbbf24' },
    ]
    maxTokens = 1000
    ```
    Stacked bar renders with correct proportions.
    Expanding details shows itemized list with correct counts.
    Clicking "Inspect" on a category shows its full text.
  </verify>
  <done>Context visualization panel renders stacked bar with color-coded segments, expandable itemized list with token counts and progress bars, and full text inspection via modal. Empty state shown when no segments.</done>
</task>

<task type="auto">
  <name>Task 2: Compression event log and integration into app layout</name>
  <files>
    src/components/context-viz/CompressionLog.tsx
    src/hooks/use-compression-log.ts
    src/App.tsx
  </files>
  <action>
    **useCompressionLog hook (src/hooks/use-compression-log.ts):**
    - Reads compression events from SQLite `compression_events` table
    - Uses TanStack Query for caching: queryKey ['compression-events']
    - Returns: events (CompressionEvent[]), addEvent (mutation), clearEvents (mutation)
    - addEvent: INSERT into compression_events, invalidates query
    - Events ordered by created_at DESC (most recent first)
    - Limit to last 50 events to prevent unbounded growth in the UI

    **CompressionLog (src/components/context-viz/CompressionLog.tsx):**
    - Collapsible section below the itemized list (collapsed by default)
    - Header: "Compression Log" with event count badge
    - Each event as a compact row:
      - Timestamp (relative: "2m ago", "1h ago")
      - Description: "{source_tier} → {target_tier}: {original_tokens} → {compressed_tokens} tokens"
      - Compression ratio: "({ratio}x)"
    - Scrollable list, max height ~150px
    - "Clear Log" button at bottom
    - When no events: "No compression events yet"

    **Integrate into App.tsx:**
    - Position ContextVisualization below the textarea in the right pane
    - Use a vertical layout in the right pane: textarea component takes flex:1, context viz takes a fixed-height bottom section (~200px)
    - Context viz receives segments from a new Zustand store slice or React state (for now, use sample/mock data to demonstrate the UI — live data comes in Plan 06)
    - Pass compressionEvents from useCompressionLog hook

    The context viz should work with mock data now and switch to live data when Plan 06 wires the generation workspace.
  </action>
  <verify>
    `npm run build` — no errors.
    Right pane shows textarea on top and context viz panel on bottom.
    Compression log section is collapsible.
    Adding a mock compression event via console (useCompressionLog.addEvent) renders in the log.
    Relative timestamps display correctly.
  </verify>
  <done>Compression log renders events with timestamps and compression ratios, collapsible UI, connected to SQLite via TanStack Query. Context visualization integrated into the right pane layout below the textarea with mock data.</done>
</task>

</tasks>

<verification>
1. `npm run build` — zero errors
2. Context visualization panel always visible below textarea
3. Stacked bar shows proportional color-coded segments
4. Expanding details shows itemized list with token counts
5. Text inspection shows full markdown-rendered content
6. Compression log shows events with relative timestamps and ratios
7. Empty states render gracefully when no data
</verification>

<success_criteria>
- Always-visible context visualization panel in right pane below textarea
- Stacked bar with color-coded segments proportional to token usage
- Expandable itemized list with label, token count, percentage, and progress bar
- Full text inspection modal for any context category
- Compression event log with timestamps, tier transitions, and ratios
- Components accept ContextTier[] props — ready for live data in Plan 06
- Mock data renders correctly as proof of concept
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-context-engine/01-05-SUMMARY.md`
</output>
